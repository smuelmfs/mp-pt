// Prisma schema — Sistema de Orçamentação Gráfica (Neon / PostgreSQL)
// Completo, com margens fixas e dinâmicas, variantes de material,
// impressão com setup/mínimo, acabamento com tipos de cálculo e arredondamento por categoria/produto.
// Campos monetários usam Decimal mapeado para @db.Numeric para precisão.
// ---------------------------------------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

// =========================
// Enums
// =========================

enum Role {
  ADMIN
  COMMERCIAL
}

enum Unit {        // unidade de medida
  UNIT             // unidade
  M2               // metro quadrado
  LOT              // lote
  HOUR             // hora
  SHEET            // folha
}

enum FinishCategory {
  LAMINACAO
  VERNIZ
  CORTE
  DOBRA
  OUTROS
}

enum FinishCalcType {
  PER_UNIT
  PER_M2
  PER_LOT
  PER_HOUR
}

enum PrintingTech {
  OFFSET
  DIGITAL
  UV
  GRANDE_FORMATO
}

enum QuoteItemType {
  MATERIAL
  PRINTING
  FINISH
  OTHER
}

enum MarginScope { // escopo da regra de margem
  GLOBAL
  CATEGORY
  PRODUCT
}

// Novos enums para arredondamento, estratégia de preço e setup
enum RoundingStrategy {
  END_ONLY     // arredonda só no final (atual)
  PER_STEP     // arredonda por etapa/linha (planilha)
}

enum PricingStrategy {
  COST_MARKUP_MARGIN   // subtotal*(1+markup)*(1+margin) (atual)
  COST_MARGIN_ONLY     // subtotal*(1+margin)
  MARGIN_TARGET        // preço = subtotal / (1 - marginTarget)
}

enum SetupMode {
  TIME_X_RATE   // setupMinutes * printingHourCost (atual)
  FLAT          // taxa fixa de setup
}

// =========================
// Apoio e Configuração
// =========================

model User {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  role      Role     @default(COMMERCIAL)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  quotes    Quote[]
}

model ProductCategory {
  id           Int      @id @default(autoincrement())
  name         String   @unique
  roundingStep Decimal? @db.Decimal(7,4) // ex.: 0.0500 (prioridade sobre global)
  roundingStrategy RoundingStrategy?
  pricingStrategy  PricingStrategy?
  minPricePerPiece Decimal? @db.Decimal(12,2)
  lossFactor       Decimal? @db.Decimal(7,4)
  products     Product[]
  marginRules  MarginRule[]
  marginRulesDynamic MarginRuleDynamic[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model ConfigGlobal {
  id                Int      @id @default(1)
  marginDefault     Decimal  @db.Decimal(7,4)  // 0.3000 = 30%
  markupOperational Decimal  @db.Decimal(7,4)  // 0.2000 = 20%
  roundingStep      Decimal? @db.Decimal(7,4)  // degrau global (ex.: 0.0500)
  lossFactor        Decimal? @db.Decimal(7,4)  // fator de perda global
  roundingStrategy  RoundingStrategy?
  pricingStrategy   PricingStrategy?
  setupTimeMin      Int?
  printingHourCost  Decimal? @db.Decimal(12,4) // custo por hora da impressão (para setup)
  vatPercent        Decimal? @db.Decimal(7,4)  // percentual de IVA (ex.: 0.2300 = 23%)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// =========================
// Insumos
// =========================

model Material {           // material genérico (papel, vinil, PVC, etc.)
  id          Int      @id @default(autoincrement())
  name        String
  type        String   // papel, vinil, pvc, alveolar...
  unit        Unit
  unitCost    Decimal  @db.Decimal(12,4) // custo por unidade (m², un, lote, folha)
  lossFactor  Decimal? @db.Decimal(7,4)
  active      Boolean  @default(true)
  // SCD2 simples
  validFrom   DateTime @default(now())
  validTo     DateTime?
  isCurrent   Boolean  @default(true)

  variants    MaterialVariant[]
  productMaterials ProductMaterial[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isCurrent])
}

model MaterialVariant {    // variante específica (ex.: Couché 300g 66x96, pack 500)
  id            Int      @id @default(autoincrement())
  materialId    Int
  label         String
  gramagem      Int?     // g/m²
  widthMm       Int?     // largura em mm
  heightMm      Int?     // altura em mm
  sheetsPerPack Int?
  packPrice     Decimal? @db.Decimal(12,4)
  unitPrice     Decimal? @db.Decimal(12,4) // derivado (packPrice/sheetsPerPack)
  isCurrent     Boolean  @default(true)
  validFrom     DateTime @default(now())
  validTo       DateTime?

  material      Material @relation(fields: [materialId], references: [id])
  productMaterials ProductMaterial[]
  optionChoices ProductOptionChoice[]

  @@index([materialId])
  @@index([isCurrent])
}

model Printing {           // parâmetros/custos de impressão
  id           Int           @id @default(autoincrement())
  technology   PrintingTech
  formatLabel  String?
  colors       String?       // ex.: 4x4, 4x0, 1x0
  sides        Int?          // 1 ou 2
  unitPrice    Decimal       @db.Decimal(12,4) // preço por impressão/folha/tiro
  yield        Int?          // rendimento por formato
  setupMinutes Int?          // tempo de acerto
  minFee       Decimal?      @db.Decimal(12,2) // valor mínimo
  setupMode    SetupMode?
  setupFlatFee Decimal?      @db.Decimal(12,2)
  lossFactor   Decimal?      @db.Decimal(7,4)
  active       Boolean       @default(true)
  validFrom    DateTime      @default(now())
  validTo      DateTime?
  isCurrent    Boolean       @default(true)

  products     Product[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([isCurrent])
}

model Finish {             // acabamentos com regras de cálculo
  id            Int             @id @default(autoincrement())
  name          String
  category      FinishCategory
  unit          Unit
  baseCost      Decimal         @db.Decimal(12,4)
  marginDefault Decimal?        @db.Decimal(7,4)
  calcType      FinishCalcType  @default(PER_UNIT)
  minFee        Decimal?        @db.Decimal(12,2)
  areaStepM2    Decimal?        @db.Decimal(12,4)
  minPerPiece   Decimal?        @db.Decimal(12,2)
  lossFactor    Decimal?        @db.Decimal(7,4)
  active        Boolean         @default(true)
  // SCD2 opcional
  validFrom     DateTime        @default(now())
  validTo       DateTime?
  isCurrent     Boolean         @default(true)

  productFinishes ProductFinish[]
  optionChoices  ProductOptionChoice[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([isCurrent])
}

// =========================
// Produtos e Composição
// =========================

model Product {
  id             Int               @id @default(autoincrement())
  name           String
  categoryId     Int
  category       ProductCategory   @relation(fields: [categoryId], references: [id])

  printingId     Int?
  printing       Printing?         @relation(fields: [printingId], references: [id])

  // Dimensões padrão do produto (para imposição automática)
  widthMm        Int?              // largura padrão em mm
  heightMm       Int?              // altura padrão em mm
  dimensionDescription String?      // descrição da orientação (ex: Vertical, Horizontal)

  // Mínimo de pedido
  minOrderQty    Int?              // quantidade mínima
  minOrderValue  Decimal?          @db.Decimal(12,2) // valor mínimo

  marginDefault  Decimal?          @db.Decimal(7,4)
  markupDefault  Decimal?          @db.Decimal(7,4)
  roundingStep   Decimal?          @db.Decimal(7,4) // prioridade sobre categoria e global
  roundingStrategy RoundingStrategy?
  pricingStrategy  PricingStrategy?
  minPricePerPiece Decimal?        @db.Decimal(12,2)
  active         Boolean           @default(true)

  attributesSchema Json?

  materials      ProductMaterial[]
  finishes       ProductFinish[]
  dimensions     ProductDimension[]
  quotes         Quote[]
  marginRules    MarginRule[]
  marginRulesDynamic MarginRuleDynamic[]
  optionGroups   ProductOptionGroup[]
  suggestedQuantities ProductSuggestedQuantity[]
  supplierPrices SupplierPrice[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model ProductMaterial {
  id           Int      @id @default(autoincrement())
  productId    Int
  materialId   Int
  qtyPerUnit   Decimal  @db.Decimal(12,4) // consumo por unidade
  wasteFactor  Decimal? @db.Decimal(7,4)  // perda adicional
  lossFactor   Decimal? @db.Decimal(7,4)
  variantId    Int?                 // se quiser amarrar a uma variante específica

  product      Product  @relation(fields: [productId], references: [id])
  material     Material @relation(fields: [materialId], references: [id])
  variant      MaterialVariant? @relation(fields: [variantId], references: [id])

  @@unique([productId, materialId])
  @@index([variantId])
}

// Custos de fornecedor (Produtos Publicitários)
model SupplierPrice {
  id        Int      @id @default(autoincrement())
  productId Int
  name      String
  unit      Unit
  cost      Decimal  @db.Decimal(12,4)
  notes     String?

  product   Product  @relation(fields: [productId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
}

model ProductDimension {
  id          Int      @id @default(autoincrement())
  productId   Int
  name        String   // ex.: "A4", "A5", "Personalizado", "Cartão de Visita"
  widthMm     Int      // largura em mm
  heightMm    Int      // altura em mm
  description String?  // descrição opcional (ex: Vertical, Horizontal)
  order       Int      @default(0) // ordem de exibição
  active      Boolean  @default(true)

  product     Product  @relation(fields: [productId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([productId])
}

model ProductFinish {
  id               Int             @id @default(autoincrement())
  productId        Int
  finishId         Int
  calcRuleOverride Unit?           // para sobrepor unidade do acabamento, se necessário
  calcTypeOverride FinishCalcType? // para sobrepor tipo de cálculo
  qtyPerUnit       Decimal?        @db.Decimal(12,4)
  costOverride     Decimal?        @db.Decimal(12,4)

  product      Product @relation(fields: [productId], references: [id])
  finish       Finish  @relation(fields: [finishId], references: [id])

  @@unique([productId, finishId])
}

// =========================
// Regras de Margem
// =========================

model MarginRule { // margem fixa
  id           Int          @id @default(autoincrement())
  scope        MarginScope  // GLOBAL, CATEGORY, PRODUCT
  categoryId   Int?
  productId    Int?
  margin       Decimal      @db.Decimal(7,4) // 0.2500 = 25%
  active       Boolean      @default(true)
  startsAt     DateTime?
  endsAt       DateTime?

  category     ProductCategory? @relation(fields: [categoryId], references: [id])
  product      Product?         @relation(fields: [productId], references: [id])

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([scope])
  @@index([categoryId])
  @@index([productId])
}

model MarginRuleDynamic { // promoções/descontos dinâmicos
  id             Int          @id @default(autoincrement())
  scope          MarginScope  // GLOBAL, CATEGORY, PRODUCT
  categoryId     Int?
  productId      Int?

  // Condições
  minSubtotal    Decimal?     @db.Decimal(12,2) // aplicar se subtotal >= minSubtotal
  minQuantity    Int?                     // aplicar se quantidade >= minQuantity

  // Ajuste
  adjustPercent  Decimal      @db.Decimal(7,4)  // -0.0500 = -5% (desconto)
  maxAdjust      Decimal?     @db.Decimal(7,4)  // teto do ajuste acumulado
  priority       Int          @default(100)     // menor = aplica primeiro
  stackable      Boolean      @default(false)   // pode acumular com outras?

  active         Boolean      @default(true)
  startsAt       DateTime?
  endsAt         DateTime?

  category       ProductCategory? @relation(fields: [categoryId], references: [id])
  product        Product?         @relation(fields: [productId], references: [id])

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([scope])
  @@index([categoryId])
  @@index([productId])
  @@index([active])
  @@index([priority])
}

// =========================
// Orçamentos e Auditoria
// =========================

model Quote {
  id            Int       @id @default(autoincrement())
  number        String    @unique
  userId        Int
  productId     Int
  quantity      Int

  params        Json      // dimensões/atributos escolhidos, etc.

  subtotal      Decimal   @db.Decimal(12,2) // material + impressão + acabamentos (antes de markup/margem)
  markupApplied Decimal   @db.Decimal(7,4)
  marginApplied Decimal   @db.Decimal(7,4)
  dynamicAdjust Decimal   @db.Decimal(7,4)  // somatório das dinâmicas aplicadas
  finalPrice    Decimal   @db.Decimal(12,2) // preço final sem IVA
  vatAmount     Decimal?  @db.Decimal(12,2) // valor do IVA
  priceGross    Decimal?  @db.Decimal(12,2) // preço final com IVA

  breakdown     Json      // extrato detalhado

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user          User      @relation(fields: [userId], references: [id])
  product       Product   @relation(fields: [productId], references: [id])
  items         QuoteItem[]
  calcLogs      CalcLog[]
}

model QuoteItem {          // detalhamento linha a linha
  id         Int           @id @default(autoincrement())
  quoteId    Int
  itemType   QuoteItemType // MATERIAL, PRINTING, FINISH, OTHER
  refId      Int?          // id do material/impressão/acabamento
  name       String
  quantity   Decimal?      @db.Decimal(12,4)
  unit       Unit?
  unitCost   Decimal?      @db.Decimal(12,4)
  totalCost  Decimal       @db.Decimal(12,4)

  quote      Quote         @relation(fields: [quoteId], references: [id])

  @@index([quoteId])
}

model CalcLog {            // auditoria do cálculo
  id         Int      @id @default(autoincrement())
  quoteId    Int?
  inputs     Json
  outputs    Json
  ruleNote   String?
  createdAt  DateTime @default(now())

  quote      Quote?   @relation(fields: [quoteId], references: [id])
}

// =========================
// Configuração de Produtos
// =========================

model ProductOptionGroup {  // grupos de opções (ex.: Papel, Tamanho, Cantos)
  id          Int      @id @default(autoincrement())
  productId   Int
  name        String   // ex.: "Papel", "Tamanho", "Cantos"
  kind        String   // "SELECT" | "RADIO" | "SIZE" | "SWITCH"
  description String?  // descrição do grupo
  order       Int      @default(0) // ordem de exibição
  required    Boolean  @default(false) // se é obrigatório escolher
  active      Boolean  @default(true)

  product     Product  @relation(fields: [productId], references: [id])
  choices     ProductOptionChoice[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([productId])
}

model ProductOptionChoice {  // escolhas dentro de um grupo (ex.: Couché 300g, A4, Cantos arredondados)
  id          Int      @id @default(autoincrement())
  groupId     Int
  name        String   // ex.: "Couché 300g", "A4", "Cantos arredondados"
  description String?  // descrição da escolha
  order       Int      @default(0) // ordem de exibição
  active      Boolean  @default(true)

  // Overrides que esta escolha pode aplicar
  materialVariantId Int?     // trocar variante de material principal
  finishId         Int?      // adicionar acabamento
  finishQtyPerUnit Decimal?  @db.Decimal(12,4) // qty por unidade do acabamento
  widthOverride    Int?      // sobrepor largura (mm)
  heightOverride   Int?      // sobrepor altura (mm)
  overrideAttrs    Json?     // atributos customizados (ex.: largura_mm, altura_mm)
  priceAdjustment  Decimal?   @db.Decimal(7,4)  // ajuste de preço (+/- %)
  priceFixed      Decimal?   @db.Decimal(12,2) // ajuste fixo de preço

  group       ProductOptionGroup @relation(fields: [groupId], references: [id])
  materialVariant MaterialVariant? @relation(fields: [materialVariantId], references: [id])
  finish      Finish? @relation(fields: [finishId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([groupId])
}

model ProductSuggestedQuantity {  // tiragens sugeridas por produto
  id          Int      @id @default(autoincrement())
  productId   Int
  quantity    Int      // ex.: 100, 250, 500, 1000
  label       String?  // ex.: "Pequena tiragem", "Tiragem média"
  order       Int      @default(0) // ordem de exibição
  active      Boolean  @default(true)

  product     Product  @relation(fields: [productId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([productId])
}
